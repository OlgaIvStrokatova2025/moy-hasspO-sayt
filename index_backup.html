<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>ХАССП Конструктор</title>
    <meta name="description" content="Создайте персонализированную систему ХАССП за 30-45 минут">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }
        
        h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
        }
        
        h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            gap: 8px;
            min-height: 48px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #333;
            border: 2px solid rgba(102, 126, 234, 0.3);
            text-align: center;
            line-height: 1.4;
        }
        
        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }
        
        .btn-secondary.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        
        .btn-large {
            padding: 18px 36px;
            font-size: 1.2rem;
            border-radius: 15px;
        }
        
        .grid {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.3);
            color: #666;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .step-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .time-indicator {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .hint {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #2980b9;
            animation: fadeIn 0.3s ease;
        }
        
        .warning {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #f39c12;
            animation: fadeIn 0.3s ease;
        }
        
        .error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #e74c3c;
            animation: fadeIn 0.3s ease;
        }
        
        .text-center {
            text-align: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .price-block {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .old-price {
            font-size: 1.2rem;
            color: #999;
            text-decoration: line-through;
        }
        
        .new-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
        }
        
        .discount-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .validation-messages {
            margin-top: 20px;
        }
        
        .validation-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        .validation-message.error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        
        label {
            font-weight: 600;
            color: #555;
        }
        
        small {
            opacity: 0.7;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .grid, .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .step-indicator {
                gap: 10px;
            }
            
            .step {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Стартовый экран -->
        <div id="welcome">
            <h1>🛡️ ХАССП Конструктор</h1>
            <div class="card text-center">
                <h2>Создайте персонализированную систему ХАССП за 30-45 минут</h2>
                <p style="margin-bottom: 30px; font-size: 1.1rem; opacity: 0.9;">
                    Полный пакет документов, адаптированный под ваше заведение
                </p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">📋</div>
                        <strong>План ХАССП</strong><br>
                        20-40 страниц под ваше заведение
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <strong>Журналы контроля</strong><br>
                        Только необходимые для вас
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">👥</div>
                        <strong>Инструкции персонала</strong><br>
                        Под вашу структуру команды
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🎯</div>
                        <strong>Анализ рисков</strong><br>
                        Критические контрольные точки
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">✅</div>
                        <strong>Готовность к проверкам</strong><br>
                        Чек-лист для РПН
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📚</div>
                        <strong>Программа обучения</strong><br>
                        Для вашего персонала
                    </div>
                </div>
                
                <div class="time-indicator">
                    <h3>⏱️ Время заполнения: 30-45 минут</h3>
                    <p>Максимум выпадающих списков, минимум ручного ввода</p>
                </div>
                
                <button class="btn btn-primary btn-large" onclick="startForm()">
                    🚀 Начать создание системы ХАССП
                </button>
            </div>
        </div>

        <!-- Форма опросника -->
        <div id="form" class="hidden">
            <div class="step-indicator">
                <div class="step active" id="step-1">1</div>
                <div class="step" id="step-2">2</div>
                <div class="step" id="step-3">3</div>
                <div class="step" id="step-4">4</div>
                <div class="step" id="step-5">5</div>
                <div class="step" id="step-6">6</div>
                <div class="step" id="step-7">7</div>
                <div class="step" id="step-8">8</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="card">
                <div class="step-header">
                    <h2 id="stepTitle">Блок 1: Основные данные предприятия</h2>
                    <p id="stepSubtitle">Время заполнения: ~5 минут</p>
                </div>
                
                <div id="stepContent">
                    <!-- Контент загружается JavaScript -->
                </div>
                
                <div id="hintsContainer"></div>
                
                <div class="validation-messages" id="validationMessages"></div>
                
                <div class="nav-buttons">
                    <button id="backBtn" class="btn btn-secondary" onclick="prevStep()" style="display: none;">
                        ← Назад
                    </button>
                    <button id="nextBtn" class="btn btn-primary" onclick="nextStep()">
                        Далее →
                    </button>
                </div>
            </div>
        </div>

        <!-- Генерация -->
        <div id="generating" class="hidden">
            <div class="card text-center">
                <div class="spinner"></div>
                <h2>Создаем вашу персонализированную систему ХАССП...</h2>
                <p id="genStatus">Анализируем данные вашего заведения...</p>
                <div class="progress-bar">
                    <div id="genProgress" class="progress-fill"></div>
                </div>
                <div id="genDetails" style="margin-top: 20px; opacity: 0.8;">
                    Обрабатываем информацию о вашем заведении...
                </div>
            </div>
        </div>

        <!-- Результат -->
        <div id="result" class="hidden">
            <div class="card text-center">
                <h1>🏆 Система ХАССП готова!</h1>
                <h2 id="resultBusinessName">Персонализированные документы для вашего заведения</h2>
                
                <div id="resultPreview" style="margin: 30px 0;">
                    <!-- Генерируется JavaScript -->
                </div>
                
                <div class="price-block">
                    <span class="old-price">19,990₽</span>
                    <span class="new-price">9,990₽</span>
                    <span class="discount-badge">СКИДКА 50%</span>
                </div>
                
                <input type="email" id="email" class="input" 
                       placeholder="📧 Ваш email для получения документов" 
                       style="max-width: 400px; margin: 20px auto; display: block;">
                
                <button class="btn btn-primary btn-large" onclick="purchase()">
                    💳 Оплатить и получить документы
                </button>
                
                <p style="margin-top: 15px; opacity: 0.8; font-size: 0.9rem;">
                    🔒 Безопасная оплата • 💳 Все способы оплаты • ↩️ Возврат денег в течение 14 дней
                </p>
            </div>
        </div>
    </div>
    <script>
        // Глобальные переменные
        let currentStep = 1;
        let formData = {};
        let validationErrors = {};

        // Конфигурация шагов
        const STEPS_CONFIG = [
            {
                id: 1,
                title: "Блок 1: Основные данные предприятия",
                subtitle: "Время заполнения: ~5 минут",
                fields: ['businessName', 'legalForm', 'inn', 'phone', 'legalAddress', 'directorName', 'businessEmail']
            },
            {
                id: 2,
                title: "Блок 2: Характеристика заведения",
                subtitle: "Время заполнения: ~10 минут", 
                fields: ['businessType', 'seatingCapacity', 'kitchenArea', 'staffCount', 'workSchedule', 'additionalServices']
            },
            {
                id: 3,
                title: "Блок 3: Кухня и технологические процессы",
                subtitle: "Время заполнения: ~10 минут",
                fields: ['productionType', 'cuisineSpecialization', 'kitchenLayout', 'productionZones', 'dishwareType']
            },
            {
                id: 4,
                title: "Блок 4: Оборудование и инфраструктура", 
                subtitle: "Время заполнения: ~10 минут",
                fields: ['heatingEquipment', 'coolingEquipment', 'equipmentMaintenance', 'controlInstruments']
            },
            {
                id: 5,
                title: "Блок 5: Уборка и санитария",
                subtitle: "Время заполнения: ~5 минут",
                fields: ['cleaningOrganization', 'cleaningSupplier', 'cleaningInventory']
            },
            {
                id: 6,
                title: "Блок 6: Меню и технологические карты",
                subtitle: "Время заполнения: ~10 минут", 
                fields: ['technicalCards', 'menuCategories', 'cookingFeatures']
            },
            {
                id: 7,
                title: "Блок 7: Поставщики и логистика",
                subtitle: "Время заполнения: ~5 минут",
                fields: ['suppliersCount', 'deliverySchedule', 'goodsAcceptance', 'documentation']
            },
            {
                id: 8,
                title: "Блок 8: Персонал",
                subtitle: "Время заполнения: ~5 минут",
                fields: ['staffStructure', 'staffTraining', 'staffTurnover']
            }
        ];

        // Старт формы
        function startForm() {
            console.log('🚀 Запуск формы');
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('form').classList.remove('hidden');
            loadSavedData();
            showStep(1);
        }

        // Показать шаг
        function showStep(step) {
            currentStep = step;
            updateStepIndicator();
            updateProgressBar();
            updateStepHeader();
            loadStepContent(step);
            updateNavigationButtons();
            clearValidationMessages();
            
            // Восстанавливаем данные после загрузки контента
            setTimeout(() => restoreStepData(step), 100);
        }

        // Загрузка контента шага
        function loadStepContent(step) {
            const stepContent = document.getElementById('stepContent');
            let content = '';

            switch(step) {
                case 1:
                    content = generateStep1Content();
                    break;
                case 2:
                    content = generateStep2Content();
                    break;
                case 3:
                    content = generateStep3Content();
                    break;
                case 4:
                    content = generateStep4Content();
                    break;
                case 5:
                    content = generateStep5Content();
                    break;
                case 6:
                    content = generateStep6Content();
                    break;
                case 7:
                    content = generateStep7Content();
                    break;
                case 8:
                    content = generateStep8Content();
                    break;
            }

            stepContent.innerHTML = content;
            
            // Привязываем обработчики событий к новым элементам
            attachEventListeners();
        }

        // Привязка обработчиков событий
        function attachEventListeners() {
            // Автосохранение для текстовых полей
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    saveFieldData(input);
                    validateField(input);
                });
                input.addEventListener('blur', () => validateField(input));
            });
        }

        // Сохранение данных поля
        function saveFieldData(input) {
            if (input.type === 'checkbox') {
                if (!formData[input.name]) formData[input.name] = [];
                if (input.checked && !formData[input.name].includes(input.value)) {
                    formData[input.name].push(input.value);
                } else if (!input.checked) {
                    formData[input.name] = formData[input.name].filter(v => v !== input.value);
                }
            } else {
                formData[input.id || input.name] = input.value;
            }
            
            // Автосохранение в localStorage
            autoSaveFormData();
        }

        // Валидация поля
        function validateField(input) {
            const fieldName = input.id || input.name;
            const value = input.value.trim();
            
            // Очищаем предыдущие ошибки
            delete validationErrors[fieldName];
            input.classList.remove('error');
            
            // Валидация обязательных полей
            if (input.hasAttribute('required') && !value) {
                validationErrors[fieldName] = 'Это поле обязательно для заполнения';
                input.classList.add('error');
                return false;
            }
            
            // Специальная валидация
            switch(fieldName) {
                case 'inn':
                    if (value && !/^\d{10}$|^\d{12}$/.test(value.replace(/\D/g, ''))) {
                        validationErrors[fieldName] = 'ИНН должен содержать 10 или 12 цифр';
                        input.classList.add('error');
                        return false;
                    }
                    break;
                case 'businessEmail':
                case 'email':
                    if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                        validationErrors[fieldName] = 'Введите корректный email адрес';
                        input.classList.add('error');
                        return false;
                    }
                    break;
                case 'phone':
                    if (value && !/^\+?[0-9\s\-\(\)]{10,}$/.test(value)) {
                        validationErrors[fieldName] = 'Введите корректный номер телефона';
                        input.classList.add('error');
                        return false;
                    }
                    break;
            }
            
            return true;
        }

        // Функции выбора опций
        function selectOption(field, value, button) {
            // Убираем активный класс у всех кнопок в группе
            const group = button.parentElement;
            group.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Добавляем активный класс к выбранной кнопке
            button.classList.add('active');
            
            // Сохраняем значение
            formData[field] = value;
            console.log('Выбрано:', field, '=', value);
            
            // Показываем умные подсказки
            showSmartHints(field, value);
            
            // Автосохранение
            autoSaveFormData();
        }

        function toggleOption(field, value, button) {
            if (!formData[field]) formData[field] = [];
            
            const index = formData[field].indexOf(value);
            if (index > -1) {
                formData[field].splice(index, 1);
                button.classList.remove('active');
            } else {
                formData[field].push(value);
                button.classList.add('active');
            }
            
            console.log('Переключено:', field, '=', formData[field]);
            
            // Показываем умные подсказки для множественного выбора
            showSmartHints(field, formData[field]);
            
            // Автосохранение
            autoSaveFormData();
        }

        // Умные подсказки (согласно ТЗ)
        function showSmartHints(field, value) {
            const hintsContainer = document.getElementById('hintsContainer');
            if (!hintsContainer) return;
            
            let hint = '';
            
            switch(field) {
                case 'businessType':
                    const businessHints = {
                        'coffeehouse': 'Для кофеен добавим контроль качества кофе, молочных продуктов и процедуры для кофемашин',
                        'delivery': 'Добавим требования к упаковке, транспортировке и контролю температуры при доставке',
                        'bar': 'Добавим процедуры проверки лицензий поставщиков алкоголя и контроль качества напитков',
                        'bakery': 'Сосредоточимся на процедурах контроля качества сырья для выпечки и температурных режимах'
                    };
                    hint = businessHints[value];
                    break;
                    
                case 'productionType':
                    const productionHints = {
                        'semi': 'Отлично! Это существенно упростит вашу систему ХАССП — многие этапы производства исключаются',
                        'full': 'Добавим все этапы: от приемки сырья до подачи готовых блюд. Система будет более детальной',
                        'ready': 'Сосредоточимся на процедурах приемки, хранения и реализации готовой продукции'
                    };
                    hint = productionHints[value];
                    break;
                    
                case 'cuisineSpecialization':
                    if (Array.isArray(value)) {
                        const hints = [];
                        if (value.includes('asian')) hints.push('Добавим процедуры для сырой рыбы (суши), соевых соусов и специфических ингредиентов');
                        if (value.includes('children')) hints.push('Усилим санитарные требования и добавим контроль аллергенов');
                        if (value.includes('vegan')) hints.push('Добавим процедуры предотвращения перекрестного загрязнения с животными продуктами');
                        if (value.includes('diet')) hints.push('Усилим контроль калорийности и пищевой ценности блюд');
                        hint = hints.join('<br>');
                    }
                    break;
                    
                case 'additionalServices':
                    if (Array.isArray(value)) {
                        const hints = [];
                        if (value.includes('alcohol')) hints.push('Добавим процедуры проверки лицензий поставщиков алкоголя и контроль качества напитков');
                        if (value.includes('childEvents')) hints.push('Усилим требования к гигиене и добавим процедуры для детского питания');
                        if (value.includes('catering')) hints.push('Добавим процедуры транспортировки и контроля температуры вне заведения');
                        if (value.includes('ownDelivery')) hints.push('Добавим контроль температурных режимов при доставке и требования к транспорту');
                        hint = hints.join('<br>');
                    }
                    break;
            }
            
            if (hint) {
                hintsContainer.innerHTML = `
                    <div class="hint">
                        💡 <strong>Умная подсказка:</strong> ${hint}
                    </div>
                `;
            } else {
                hintsContainer.innerHTML = '';
            }
        }

        // Навигация
        function nextStep() {
            // Сохраняем данные текущего шага
            saveCurrentStepData();
            
            // Валидируем текущий шаг
            if (!validateCurrentStep()) {
                showValidationErrors();
                return;
            }
            
            if (currentStep < 8) {
                showStep(currentStep + 1);
            } else {
                generateDocuments();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                saveCurrentStepData();
                showStep(currentStep - 1);
            }
        }

        // Сохранение данных текущего шага
        function saveCurrentStepData() {
            const stepContainer = document.getElementById('stepContent');
            if (!stepContainer) return;
            
            // Сохраняем все поля ввода
            const inputs = stepContainer.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                saveFieldData(input);
            });
        }

        // Восстановление данных шага
        function restoreStepData(step) {
            const stepContainer = document.getElementById('stepContent');
            if (!stepContainer) return;
            
            // Восстанавливаем значения полей
            const inputs = stepContainer.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const fieldName = input.id || input.name;
                if (formData[fieldName] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = Array.isArray(formData[fieldName]) 
                            ? formData[fieldName].includes(input.value)
                            : formData[fieldName] === input.value;
                    } else {
                        input.value = formData[fieldName];
                    }
                }
            });
            
            // Восстанавливаем активные кнопки
            const buttons = stepContainer.querySelectorAll('.btn-secondary');
            buttons.forEach(button => {
                const fieldName = button.getAttribute('data-field');
                const value = button.getAttribute('data-value');
                const isMultiple = button.getAttribute('data-multiple') === 'true';
                
                if (fieldName && value && formData[fieldName] !== undefined) {
                    if (isMultiple) {
                        if (Array.isArray(formData[fieldName]) && formData[fieldName].includes(value)) {
                            button.classList.add('active');
                        }
                    } else {
                        if (formData[fieldName] === value) {
                            button.classList.add('active');
                        }
                    }
                }
            });
        }

        // Валидация текущего шага
        function validateCurrentStep() {
            const stepConfig = STEPS_CONFIG[currentStep - 1];
            let isValid = true;
            
            // Очищаем предыдущие ошибки
            validationErrors = {};
            
            // Валидируем поля текущего шага
            stepConfig.fields.forEach(fieldName => {
                const fieldElement = document.getElementById(fieldName) || 
                                   document.querySelector(`[name="${fieldName}"]`);
                
                if (fieldElement && fieldElement.hasAttribute('required')) {
                    if (!validateField(fieldElement)) {
                        isValid = false;
                    }
                }
            });
            
            // Дополнительная логическая валидация
            isValid = validateStepLogic(currentStep) && isValid;
            
            return isValid;
        }

        // Логическая валидация по шагам
        function validateStepLogic(step) {
            let isValid = true;
            
            switch(step) {
                case 1:
                    // Проверка обязательных полей блока 1
                    const requiredFields1 = ['businessName', 'legalForm', 'inn', 'phone', 'legalAddress', 'directorName', 'businessEmail'];
                    requiredFields1.forEach(field => {
                        if (!formData[field] || formData[field].trim() === '') {
                            validationErrors[field] = 'Поле обязательно для заполнения';
                            isValid = false;
                        }
                    });
                    break;
                    
                case 2:
                    // Проверка логики размеров заведения
                    if (formData.businessType === 'restaurant' && formData.seatingCapacity === 'none') {
                        validationErrors.seatingCapacity = 'Рестораны обычно имеют зал для гостей';
                        isValid = false;
                    }
                    
                    if (formData.seatingCapacity === '200+' && formData.kitchenArea === 'up20') {
                        validationErrors.kitchenArea = 'Для 200+ гостей кухня кажется маленькой';
                        isValid = false;
                    }
                    break;
                    
                case 3:
                    // Проверка производственных зон
                    if (!formData.productionZones || !formData.productionZones.includes('restroom')) {
                        validationErrors.productionZones = 'Санузел для персонала обязателен по СанПиН';
                        isValid = false;
                    }
                    break;
                    
                case 5:
                    // Проверка моющих средств
                    if (formData.cleaningSupplier === 'folk') {
                        validationErrors.cleaningSupplier = 'Народные средства запрещены для пищевых предприятий';
                        isValid = false;
                    }
                    break;
                    
                case 7:
                    // Проверка документооборота
                    if (formData.documentation && formData.documentation.includes('minimal')) {
                        validationErrors.documentation = 'Приемка без проверок недопустима для пищевых предприятий';
                        isValid = false;
                    }
                    break;
            }
            
            return isValid;
        }

        // Показ ошибок валидации
        function showValidationErrors() {
            const container = document.getElementById('validationMessages');
            if (!container || Object.keys(validationErrors).length === 0) return;
            
            const errorHtml = Object.entries(validationErrors).map(([field, error]) => 
                `<div class="validation-message error">❌ ${error}</div>`
            ).join('');
            
            container.innerHTML = errorHtml;
            
            // Скроллим к ошибкам
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Очистка сообщений валидации
        function clearValidationMessages() {
            const container = document.getElementById('validationMessages');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Автосохранение
        function autoSaveFormData() {
            try {
                localStorage.setItem('haccpFormData', JSON.stringify(formData));
                localStorage.setItem('haccpCurrentStep', currentStep.toString());
            } catch (e) {
                console.warn('Не удалось автосохранить данные:', e);
            }
        }

        // Загрузка сохраненных данных
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('haccpFormData');
                const savedStep = localStorage.getItem('haccpCurrentStep');
                
                if (savedData) {
                    formData = JSON.parse(savedData);
                    console.log('Загружены сохраненные данные:', formData);
                }
                
                if (savedStep) {
                    currentStep = parseInt(savedStep);
                }
                
                return Object.keys(formData).length > 0;
            } catch (e) {
                console.warn('Не удалось загрузить сохраненные данные:', e);
                return false;
            }
        }
        // Генерация контента шагов
        function generateStep1Content() {
            return `
                <h3>1.1 Реквизиты организации</h3>
                <div class="grid-2">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Наименование организации *</label>
                        <input type="text" id="businessName" class="input" placeholder="Укажите полное название как в документах" required>
                        <small>💬 Влияет на все документы ХАССП</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Организационно-правовая форма *</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('legalForm', 'ip', this)" data-field="legalForm" data-value="ip">ИП</button>
                            <button class="btn btn-secondary" onclick="selectOption('legalForm', 'ooo', this)" data-field="legalForm" data-value="ooo">ООО</button>
                            <button class="btn btn-secondary" onclick="selectOption('legalForm', 'ao', this)" data-field="legalForm" data-value="ao">АО</button>
                            <button class="btn btn-secondary" onclick="selectOption('legalForm', 'other', this)" data-field="legalForm" data-value="other">Другое</button>
                        </div>
                        <small>💡 Влияет на перечень обязательных документов ХАССП</small>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ИНН *</label>
                        <input type="text" id="inn" class="input" placeholder="1234567890" maxlength="12" required>
                        <small>⚠️ Проверка корректности ИНН</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Телефон *</label>
                        <input type="tel" id="phone" class="input" placeholder="+7 (999) 123-45-67" required>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Юридический адрес *</label>
                    <input type="text" id="legalAddress" class="input" placeholder="Полный адрес регистрации организации" required>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Фактический адрес заведения</label>
                    <input type="text" id="actualAddress" class="input" placeholder="Адрес, где фактически работает заведение">
                    <label style="display: flex; align-items: center; margin-top: 10px; cursor: pointer;">
                        <input type="checkbox" id="sameAddress" style="margin-right: 10px;" onchange="toggleSameAddress()">
                        <span>Совпадает с юридическим адресом</span>
                    </label>
                </div>
                
                <h3>1.2 Руководство и контакты</h3>
                <div class="grid-2">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ФИО руководителя *</label>
                        <input type="text" id="directorName" class="input" placeholder="Иванов Иван Иванович" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Должность руководителя *</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('directorPosition', 'director', this)" data-field="directorPosition" data-value="director">Директор</button>
                            <button class="btn btn-secondary" onclick="selectOption('directorPosition', 'manager', this)" data-field="directorPosition" data-value="manager">Управляющий</button>
                            <button class="btn btn-secondary" onclick="selectOption('directorPosition', 'owner', this)" data-field="directorPosition" data-value="owner">Собственник</button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email *</label>
                    <input type="email" id="businessEmail" class="input" placeholder="info@restaurant.ru" required>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ответственный за ХАССП *</label>
                    <div class="grid">
                        <button class="btn btn-secondary" onclick="selectOption('haccpResponsible', 'same', this)" data-field="haccpResponsible" data-value="same">Тот же руководитель</button>
                        <button class="btn btn-secondary" onclick="selectOption('haccpResponsible', 'other', this)" data-field="haccpResponsible" data-value="other">Другое лицо</button>
                    </div>
                    <div id="otherResponsible" class="hidden" style="margin-top: 15px;">
                        <input type="text" id="haccpResponsibleName" class="input" placeholder="ФИО ответственного за ХАССП" style="margin-bottom: 10px;">
                        <input type="text" id="haccpResponsiblePosition" class="input" placeholder="Должность">
                    </div>
                    <small>💡 По закону должно быть назначено ответственное лицо за пищевую безопасность</small>
                </div>
            `;
        }

        function generateStep2Content() {
            return `
                <h3>2.1 Тип и формат заведения</h3>
                <p style="margin-bottom: 15px;">Выберите основной тип вашего заведения:</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'restaurant', this)" data-field="businessType" data-value="restaurant">
                        🍽️ <strong>Ресторан</strong><br>
                        <small>Полное обслуживание, широкая кухня</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'cafe', this)" data-field="businessType" data-value="cafe">
                        ☕ <strong>Кафе</strong><br>
                        <small>Ограниченное меню, быстрое обслуживание</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'canteen', this)" data-field="businessType" data-value="canteen">
                        🍛 <strong>Столовая</strong><br>
                        <small>Комплексные обеды, самообслуживание</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'coffeehouse', this)" data-field="businessType" data-value="coffeehouse">
                        ☕ <strong>Кофейня</strong><br>
                        <small>Кофе, легкие закуски, десерты</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'bar', this)" data-field="businessType" data-value="bar">
                        🍸 <strong>Бар</strong><br>
                        <small>Напитки + легкие закуски</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'fastfood', this)" data-field="businessType" data-value="fastfood">
                        🍔 <strong>Фастфуд</strong><br>
                        <small>Быстрое питание, стандартизированное меню</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'delivery', this)" data-field="businessType" data-value="delivery">
                        🚗 <strong>Только доставка</strong><br>
                        <small>Темная кухня, без зала</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('businessType', 'bakery', this)" data-field="businessType" data-value="bakery">
                        🥐 <strong>Кондитерская/Пекарня</strong><br>
                        <small>Выпечка, кондитерские изделия</small>
                    </button>
                </div>
                
                <h3>2.2 Размер заведения</h3>
                <div class="grid-2">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Посадочных мест</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('seatingCapacity', 'none', this)" data-field="seatingCapacity" data-value="none">Без мест/<br>На вынос</button>
                            <button class="btn btn-secondary" onclick="selectOption('seatingCapacity', 'up20', this)" data-field="seatingCapacity" data-value="up20">До 20</button>
                            <button class="btn btn-secondary" onclick="selectOption('seatingCapacity', '21-50', this)" data-field="seatingCapacity" data-value="21-50">21-50</button>
                            <button class="btn btn-secondary" onclick="selectOption('seatingCapacity', '51-100', this)" data-field="seatingCapacity" data-value="51-100">51-100</button>
                            <button class="btn btn-secondary" onclick="selectOption('seatingCapacity', '101-200', this)" data-field="seatingCapacity" data-value="101-200">101-200</button>
                            <button class="btn btn-secondary" onclick="selectOption('seatingCapacity', '200+', this)" data-field="seatingCapacity" data-value="200+">200+</button>
                        </div>
                        <small>💬 Влияет на объем документации и количество процедур</small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Площадь кухни</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('kitchenArea', 'up20', this)" data-field="kitchenArea" data-value="up20">До 20 м²</button>
                            <button class="btn btn-secondary" onclick="selectOption('kitchenArea', '21-50', this)" data-field="kitchenArea" data-value="21-50">21-50 м²</button>
                            <button class="btn btn-secondary" onclick="selectOption('kitchenArea', '51-100', this)" data-field="kitchenArea" data-value="51-100">51-100 м²</button>
                            <button class="btn btn-secondary" onclick="selectOption('kitchenArea', '100+', this)" data-field="kitchenArea" data-value="100+">100+ м²</button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Персонал на кухне</label>
                    <div class="grid">
                        <button class="btn btn-secondary" onclick="selectOption('staffCount', '1-2', this)" data-field="staffCount" data-value="1-2">1-2 чел.</button>
                        <button class="btn btn-secondary" onclick="selectOption('staffCount', '3-5', this)" data-field="staffCount" data-value="3-5">3-5 чел.</button>
                        <button class="btn btn-secondary" onclick="selectOption('staffCount', '6-10', this)" data-field="staffCount" data-value="6-10">6-10 чел.</button>
                        <button class="btn btn-secondary" onclick="selectOption('staffCount', '11+', this)" data-field="staffCount" data-value="11+">11+ чел.</button>
                    </div>
                </div>
                
                <h3>2.3 Режим работы</h3>
                <div class="grid-2">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">График работы</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('workSchedule', 'breakfast-lunch', this)" data-field="workSchedule" data-value="breakfast-lunch">Завтрак+обед<br><small>(6:00-16:00)</small></button>
                            <button class="btn btn-secondary" onclick="selectOption('workSchedule', 'lunch-dinner', this)" data-field="workSchedule" data-value="lunch-dinner">Обед+ужин<br><small>(11:00-23:00)</small></button>
                            <button class="btn btn-secondary" onclick="selectOption('workSchedule', 'full-day', this)" data-field="workSchedule" data-value="full-day">Полный день<br><small>(8:00-22:00)</small></button>
                            <button class="btn btn-secondary" onclick="selectOption('workSchedule', '24-7', this)" data-field="workSchedule" data-value="24-7">Круглосуточно<br><small>(24/7)</small></button>
                        </div>
                        <small>💬 Влияет на график контрольных мероприятий</small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Дни работы</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('workDays', '7days', this)" data-field="workDays" data-value="7days">7 дней в неделю</button>
                            <button class="btn btn-secondary" onclick="selectOption('workDays', '6days-mon', this)" data-field="workDays" data-value="6days-mon">6 дней<br><small>(выходной понедельник)</small></button>
                            <button class="btn btn-secondary" onclick="selectOption('workDays', '5days', this)" data-field="workDays" data-value="5days">5 дней<br><small>(выходные сб-вс)</small></button>
                            <button class="btn btn-secondary" onclick="selectOption('workDays', 'other', this)" data-field="workDays" data-value="other">Другой график</button>
                        </div>
                    </div>
                </div>
                
                <h3>2.4 Дополнительные услуги</h3>
                <p style="margin-bottom: 15px;">Отметьте все подходящие варианты:</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('additionalServices', 'ownDelivery', this)" data-field="additionalServices" data-value="ownDelivery" data-multiple="true">
                        🚚 Доставка собственными силами
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('additionalServices', 'aggregators', this)" data-field="additionalServices" data-value="aggregators" data-multiple="true">
                        📱 Доставка через агрегаторы<br>
                        <small>(Яндекс.Еда, Delivery Club)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('additionalServices', 'banquets', this)" data-field="additionalServices" data-value="banquets" data-multiple="true">
                        🎉 Банкетное обслуживание
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('additionalServices', 'childEvents', this)" data-field="additionalServices" data-value="childEvents" data-multiple="true">
                        🎈 Детские мероприятия
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('additionalServices', 'catering', this)" data-field="additionalServices" data-value="catering" data-multiple="true">
                        🎪 Кейтеринг<br>
                        <small>(выездное обслуживание)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('additionalServices', 'alcohol', this)" data-field="additionalServices" data-value="alcohol" data-multiple="true">
                        🍷 Продажа алкогольных напитков
                    </button>
                </div>
            `;
        }

        function generateStep3Content() {
            return `
                <h3>3.1 Тип производства</h3>
                <p style="margin-bottom: 15px;">Основной способ приготовления блюд:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('productionType', 'full', this)" data-field="productionType" data-value="full">
                        🥕 <strong>Полный цикл</strong><br>
                        <small>Готовим все с нуля из сырых продуктов</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('productionType', 'semi', this)" data-field="productionType" data-value="semi">
                        🍲 <strong>Полуфабрикаты</strong><br>
                        <small>Используем готовые полуфабрикаты + минимальная обработка</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('productionType', 'mixed', this)" data-field="productionType" data-value="mixed">
                        🔄 <strong>Смешанный</strong><br>
                        <small>Часть блюд с нуля, часть из полуфабрикатов</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('productionType', 'reheat', this)" data-field="productionType" data-value="reheat">
                        🔥 <strong>Только разогрев</strong><br>
                        <small>Разогрев готовых блюд</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('productionType', 'ready', this)" data-field="productionType" data-value="ready">
                        🛒 <strong>Реализация готовых изделий</strong><br>
                        <small>Кондитерские изделия, выпечка без собственного производства</small>
                    </button>
                </div>
                
                <h3>3.2 Специализация кухни</h3>
                <p style="margin-bottom: 15px;">Основные направления (выберите до 3-х):</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'european', this)" data-field="cuisineSpecialization" data-value="european" data-multiple="true">
                        🇪🇺 Европейская кухня
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'russian', this)" data-field="cuisineSpecialization" data-value="russian" data-multiple="true">
                        🇷🇺 Русская/славянская кухня
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'asian', this)" data-field="cuisineSpecialization" data-value="asian" data-multiple="true">
                        🥢 Азиатская кухня<br>
                        <small>(китайская, японская, тайская)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'eastern', this)" data-field="cuisineSpecialization" data-value="eastern" data-multiple="true">
                        🥙 Восточная кухня<br>
                        <small>(кавказская, среднеазиатская)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'italian', this)" data-field="cuisineSpecialization" data-value="italian" data-multiple="true">
                        🍕 Итальянская<br>
                        <small>(пицца, паста)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'fastfood', this)" data-field="cuisineSpecialization" data-value="fastfood" data-multiple="true">
                        🍔 Фастфуд<br>
                        <small>(бургеры, картофель фри)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'vegan', this)" data-field="cuisineSpecialization" data-value="vegan" data-multiple="true">
                        🌱 Веганская/вегетарианская
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'children', this)" data-field="cuisineSpecialization" data-value="children" data-multiple="true">
                        👶 Детская кухня
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'diet', this)" data-field="cuisineSpecialization" data-value="diet" data-multiple="true">
                        💊 Диетическая кухня
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cuisineSpecialization', 'mixed', this)" data-field="cuisineSpecialization" data-value="mixed" data-multiple="true">
                        🌍 Смешанная<br>
                        <small>(без специализации)</small>
                    </button>
                </div>
                
                <h3>3.3 Планировка помещений</h3>
                <p style="margin-bottom: 15px;">Выберите планировку, наиболее похожую на вашу:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('kitchenLayout', 'linear', this)" data-field="kitchenLayout" data-value="linear">
                        ➖ <strong>Линейная кухня</strong><br>
                        <small>Все оборудование в линию</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('kitchenLayout', 'l-shaped', this)" data-field="kitchenLayout" data-value="l-shaped">
                        📐 <strong>L-образная кухня</strong><br>
                        <small>Оборудование буквой L</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('kitchenLayout', 'island', this)" data-field="kitchenLayout" data-value="island">
                        🏝️ <strong>Островная кухня</strong><br>
                        <small>Рабочая зона в центре</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('kitchenLayout', 'open', this)" data-field="kitchenLayout" data-value="open">
                        👁️ <strong>Открытая кухня</strong><br>
                        <small>Видна из зала</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('kitchenLayout', 'separate', this)" data-field="kitchenLayout" data-value="separate">
                        🏢 <strong>Отдельные цеха</strong><br>
                        <small>Заготовочный, горячий, холодный</small>
                    </button>
                </div>
                
                <h3>3.4 Производственные зоны</h3>
                <p style="margin-bottom: 15px;">Какие зоны есть в вашей кухне:</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'prep', this)" data-field="productionZones" data-value="prep" data-multiple="true">
                        🥒 Заготовочная зона<br>
                        <small>Первичная обработка сырья</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'hot', this)" data-field="productionZones" data-value="hot" data-multiple="true">
                        🔥 Горячий цех<br>
                        <small>Плиты, духовки, фритюр</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'cold', this)" data-field="productionZones" data-value="cold" data-multiple="true">
                        🥗 Холодный цех<br>
                        <small>Салаты, закуски, десерты</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'pastry', this)" data-field="productionZones" data-value="pastry" data-multiple="true">
                        🧁 Кондитерский цех
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'bakery', this)" data-field="productionZones" data-value="bakery" data-multiple="true">
                        🥖 Пекарский цех
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'dishWashDining', this)" data-field="productionZones" data-value="dishWashDining" data-multiple="true">
                        🍽️ Моечная столовой посуды
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'dishWashKitchen', this)" data-field="productionZones" data-value="dishWashKitchen" data-multiple="true">
                        🍳 Моечная кухонной посуды
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'dryStorage', this)" data-field="productionZones" data-value="dryStorage" data-multiple="true">
                        📦 Склад сухих продуктов
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'coldStorage', this)" data-field="productionZones" data-value="coldStorage" data-multiple="true">
                        ❄️ Холодильная/морозильная камера
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'restroom', this)" data-field="productionZones" data-value="restroom" data-multiple="true">
                        🚻 Санузел для персонала
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('productionZones', 'staffArea', this)" data-field="productionZones" data-value="staffArea" data-multiple="true">
                        👔 Отдельная зона для персонала<br>
                        <small>(раздевалка, душ)</small>
                    </button>
                </div>
                
                <h3>3.5 Использование одноразовой посуды</h3>
                <p style="margin-bottom: 15px;">Используете ли одноразовую посуду:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('dishwareType', 'reusable', this)" data-field="dishwareType" data-value="reusable">
                        🍽️ <strong>Только многоразовая посуда</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('dishwareType', 'disposable', this)" data-field="dishwareType" data-value="disposable">
                        🥤 <strong>Только одноразовая посуда</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('dishwareType', 'mixed', this)" data-field="dishwareType" data-value="mixed">
                        🔄 <strong>Смешанно</strong><br>
                        <small>В зале многоразовая, на вынос одноразовая</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('dishwareType', 'choice', this)" data-field="dishwareType" data-value="choice">
                        ✅ <strong>Выбор предоставляется клиенту</strong>
                    </button>
                </div>
            `;
        }

        function generateStep4Content() {
            return `
                <h3>4.1 Основное кухонное оборудование</h3>
                <h4 style="color: #667eea; font-size: 1.1rem; margin: 20px 0 15px 0;">Тепловое оборудование:</h4>
                
                <div class="grid-3">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="heatingEquipment" value="gasStove" onchange="handleEquipmentChange(this)">
                        <span>🔥 Плита газовая</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="heatingEquipment" value="electricStove" onchange="handleEquipmentChange(this)">
                        <span>⚡ Плита электрическая</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="heatingEquipment" value="oven" onchange="handleEquipmentChange(this)">
                        <span>🔥 Духовой шкаф</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="heatingEquipment" value="fryer" onchange="handleEquipmentChange(this)">
                        <span>🍟 Фритюрница</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="heatingEquipment" value="grill" onchange="handleEquipmentChange(this)">
                        <span>🔥 Гриль</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="heatingEquipment" value="microwave" onchange="handleEquipmentChange(this)">
                        <span>📡 Микроволновая печь</span>
                    </label>
                </div>
                
                <h4 style="color: #667eea; font-size: 1.1rem; margin: 20px 0 15px 0;">Холодильное оборудование:</h4>
                
                <div class="grid-3">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="coolingEquipment" value="fridgeCabinet" onchange="handleEquipmentChange(this)">
                        <span>🧊 Холодильный шкаф</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="coolingEquipment" value="freezerCabinet" onchange="handleEquipmentChange(this)">
                        <span>❄️ Морозильный шкаф</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="coolingEquipment" value="fridgeCamera" onchange="handleEquipmentChange(this)">
                        <span>🏢 Холодильная камера</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="coolingEquipment" value="freezerCamera" onchange="handleEquipmentChange(this)">
                        <span>🧊 Морозильная камера</span>
                    </label>
                </div>
                
                <h3>4.2 Обслуживание оборудования</h3>
                <p style="margin-bottom: 15px;">Как обслуживается оборудование:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('equipmentMaintenance', 'contract', this)" data-field="equipmentMaintenance" data-value="contract">
                        📋 <strong>Полностью по договорам</strong><br>
                        <small>с сервисными компаниями</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('equipmentMaintenance', 'inhouse', this)" data-field="equipmentMaintenance" data-value="inhouse">
                        🔧 <strong>Полностью своими силами</strong><br>
                        <small>есть штатный механик/электрик</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('equipmentMaintenance', 'mixed', this)" data-field="equipmentMaintenance" data-value="mixed">
                        🔄 <strong>Смешанно</strong><br>
                        <small>мелкий ремонт своими силами, крупный по договорам</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('equipmentMaintenance', 'breakdown', this)" data-field="equipmentMaintenance" data-value="breakdown">
                        ⚠️ <strong>По мере поломки</strong><br>
                        <small>без планового обслуживания</small>
                    </button>
                </div>
                
                <h3>4.3 Контрольно-измерительные приборы</h3>
                <p style="margin-bottom: 15px;">Какие приборы используете для контроля:</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('controlInstruments', 'productThermometer', this)" data-field="controlInstruments" data-value="productThermometer" data-multiple="true">
                        🌡️ Термометры для продуктов
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('controlInstruments', 'fridgeThermometer', this)" data-field="controlInstruments" data-value="fridgeThermometer" data-multiple="true">
                        🧊 Термометры для холодильников
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('controlInstruments', 'scales', this)" data-field="controlInstruments" data-value="scales" data-multiple="true">
                        ⚖️ Весы
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('controlInstruments', 'phMeter', this)" data-field="controlInstruments" data-value="phMeter" data-multiple="true">
                        🧪 pH-метры
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('controlInstruments', 'none', this)" data-field="controlInstruments" data-value="none" style="border-color: #ef4444; grid-column: 1 / -1;">
                        ❌ Не используем контрольные приборы
                    </button>
                </div>
            `;
        }

        // Обработчик для оборудования
        function handleEquipmentChange(checkbox) {
            const fieldName = checkbox.name;
            const value = checkbox.value;
            
            if (!formData[fieldName]) formData[fieldName] = [];
            
            if (checkbox.checked) {
                if (!formData[fieldName].includes(value)) {
                    formData[fieldName].push(value);
                }
                checkbox.parentElement.style.borderColor = '#667eea';
                checkbox.parentElement.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
            } else {
                formData[fieldName] = formData[fieldName].filter(item => item !== value);
                checkbox.parentElement.style.borderColor = '#ddd';
                checkbox.parentElement.style.backgroundColor = 'transparent';
            }
            
            console.log('Оборудование:', fieldName, '=', formData[fieldName]);
            autoSaveFormData();
        }
        function generateStep5Content() {
            return `
                <h3>5.1 Организация уборки</h3>
                <p style="margin-bottom: 15px;">Кто выполняет уборку помещений:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('cleaningOrganization', 'staff', this)" data-field="cleaningOrganization" data-value="staff">
                        👥 <strong>Штатные уборщики</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('cleaningOrganization', 'company', this)" data-field="cleaningOrganization" data-value="company">
                        🏢 <strong>Клининговая компания</strong><br>
                        <small>по договору</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('cleaningOrganization', 'cooks', this)" data-field="cleaningOrganization" data-value="cooks">
                        👨‍🍳 <strong>Повара убирают сами</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('cleaningOrganization', 'mixed', this)" data-field="cleaningOrganization" data-value="mixed">
                        🔄 <strong>Смешанная система</strong><br>
                        <small>кухню повара, зал - уборщики</small>
                    </button>
                </div>
                
                <h3>5.2 Моющие и дезинфицирующие средства</h3>
                <div class="grid-2">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Кто обеспечивает химией:</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('cleaningSupplier', 'self', this)" data-field="cleaningSupplier" data-value="self">
                                🛒 Покупаем сами<br>
                                <small>в магазинах</small>
                            </button>
                            <button class="btn btn-secondary" onclick="selectOption('cleaningSupplier', 'supplier', this)" data-field="cleaningSupplier" data-value="supplier">
                                📋 Поставщик по договору<br>
                                <small>с документами соответствия</small>
                            </button>
                            <button class="btn btn-secondary" onclick="selectOption('cleaningSupplier', 'cleaning', this)" data-field="cleaningSupplier" data-value="cleaning">
                                🏢 Клининговая компания<br>
                                <small>предоставляет</small>
                            </button>
                            <button class="btn btn-secondary" onclick="selectOption('cleaningSupplier', 'folk', this)" data-field="cleaningSupplier" data-value="folk" style="border-color: #ef4444;">
                                🧂 Народные средства<br>
                                <small>(сода, уксус и т.д.)</small>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Документы на моющие средства:</label>
                        <div class="grid">
                            <button class="btn btn-secondary" onclick="selectOption('cleaningDocs', 'full', this)" data-field="cleaningDocs" data-value="full">
                                ✅ Есть сертификаты<br>
                                <small>на все используемые средства</small>
                            </button>
                            <button class="btn btn-secondary" onclick="selectOption('cleaningDocs', 'partial', this)" data-field="cleaningDocs" data-value="partial">
                                ⚠️ Есть частично
                            </button>
                            <button class="btn btn-secondary" onclick="selectOption('cleaningDocs', 'none', this)" data-field="cleaningDocs" data-value="none" style="border-color: #ef4444;">
                                ❌ Нет документов
                            </button>
                            <button class="btn btn-secondary" onclick="selectOption('cleaningDocs', 'unknown', this)" data-field="cleaningDocs" data-value="unknown">
                                ❓ Не знаю, что нужны<br>
                                <small>документы</small>
                            </button>
                        </div>
                    </div>
                </div>
                
                <h3>5.3 Уборочный инвентарь</h3>
                <p style="margin-bottom: 15px;">Как организована система уборочного инвентаря:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('cleaningInventory', 'colorCoded', this)" data-field="cleaningInventory" data-value="colorCoded">
                        🌈 <strong>Есть цветовая маркировка</strong><br>
                        <small>разные цвета для разных зон</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('cleaningInventory', 'universal', this)" data-field="cleaningInventory" data-value="universal">
                        🔄 <strong>Единый инвентарь</strong><br>
                        <small>для всех помещений</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('cleaningInventory', 'separate', this)" data-field="cleaningInventory" data-value="separate">
                        🏢 <strong>Отдельный инвентарь</strong><br>
                        <small>для кухни и зала</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('cleaningInventory', 'notConsidered', this)" data-field="cleaningInventory" data-value="notConsidered">
                        ❓ <strong>Не задумывались об этом</strong>
                    </button>
                </div>
            `;
        }

        function generateStep6Content() {
            return `
                <h3>6.1 Наличие технологических карт</h3>
                <p style="margin-bottom: 15px;">Есть ли у вас готовые ТТК (технологические карты):</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('technicalCards', 'full', this)" data-field="technicalCards" data-value="full">
                        ✅ <strong>Да, есть полный комплект ТТК</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('technicalCards', 'partial', this)" data-field="technicalCards" data-value="partial">
                        ⚠️ <strong>Есть частично</strong><br>
                        <small>на основные блюда</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('technicalCards', 'recipes', this)" data-field="technicalCards" data-value="recipes">
                        📝 <strong>Есть только рецептуры</strong><br>
                        <small>без ТТК</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('technicalCards', 'none', this)" data-field="technicalCards" data-value="none" style="border-color: #ef4444;">
                        ❌ <strong>Нет, готовим "по памяти"</strong>
                    </button>
                </div>
                
                <h3>6.2 Основные категории блюд в меню</h3>
                
                <h4 style="color: #667eea; margin: 20px 0 15px 0;">Холодные блюда и закуски:</h4>
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'freshSalads', this)" data-field="menuCategories" data-value="freshSalads" data-multiple="true">
                        🥗 Салаты из свежих овощей
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'dressingsSalads', this)" data-field="menuCategories" data-value="dressingsSalads" data-multiple="true">
                        🥗 Салаты с майонезом/соусами
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'meatFishCuts', this)" data-field="menuCategories" data-value="meatFishCuts" data-multiple="true">
                        🍖 Мясные/рыбные нарезки
                    </button>
                </div>
                
                <h4 style="color: #667eea; margin: 20px 0 15px 0;">Горячие блюда:</h4>
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'meatDishes', this)" data-field="menuCategories" data-value="meatDishes" data-multiple="true">
                        🥩 Мясные блюда
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'poultryDishes', this)" data-field="menuCategories" data-value="poultryDishes" data-multiple="true">
                        🐔 Птица
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'fishSeafood', this)" data-field="menuCategories" data-value="fishSeafood" data-multiple="true">
                        🐟 Рыба и морепродукты
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'pizza', this)" data-field="menuCategories" data-value="pizza" data-multiple="true">
                        🍕 Пицца
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'soups', this)" data-field="menuCategories" data-value="soups" data-multiple="true">
                        🍲 Супы
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('menuCategories', 'garnish', this)" data-field="menuCategories" data-value="garnish" data-multiple="true">
                        🥔 Гарниры
                    </button>
                </div>
                
                <h3>6.3 Особенности приготовления</h3>
                <p style="margin-bottom: 15px;">Используете ли в приготовлении:</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('cookingFeatures', 'rawEggs', this)" data-field="cookingFeatures" data-value="rawEggs" data-multiple="true" style="border-color: #ef4444;">
                        🥚 <strong>Сырые яйца</strong><br>
                        <small>(в майонезе, креме, коктейлях)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cookingFeatures', 'rawFish', this)" data-field="cookingFeatures" data-value="rawFish" data-multiple="true" style="border-color: #ef4444;">
                        🍣 <strong>Сырую рыбу</strong><br>
                        <small>(суши, сашими, строганина)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('cookingFeatures', 'rareMeat', this)" data-field="cookingFeatures" data-value="rareMeat" data-multiple="true" style="border-color: #f39c12;">
                        🥩 <strong>Мясо слабой прожарки</strong><br>
                        <small>(стейки с кровью)</small>
                    </button>
                </div>
            `;
        }

        function generateStep7Content() {
            return `
                <h3>7.1 Поставщики продуктов</h3>
                <p style="margin-bottom: 15px;">Количество основных поставщиков:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('suppliersCount', '1-2', this)" data-field="suppliersCount" data-value="1-2">
                        🏢 <strong>1-2 поставщика</strong><br>
                        <small>все от одной компании</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('suppliersCount', '3-5', this)" data-field="suppliersCount" data-value="3-5">
                        📦 <strong>3-5 поставщиков</strong><br>
                        <small>специализированные</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('suppliersCount', '6-10', this)" data-field="suppliersCount" data-value="6-10">
                        🏪 <strong>6-10 поставщиков</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('suppliersCount', '10+', this)" data-field="suppliersCount" data-value="10+">
                        📋 <strong>Более 10 поставщиков</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('suppliersCount', 'retail', this)" data-field="suppliersCount" data-value="retail" style="border-color: #f39c12;">
                        🛒 <strong>Покупаем в магазинах/на рынке</strong>
                    </button>
                </div>
                
                <h3>7.2 График поставок</h3>
                <p style="margin-bottom: 15px;">Как часто получаете продукты:</p>
                
                <div class="grid">
                    <button class="btn btn-secondary" onclick="selectOption('deliverySchedule', 'daily', this)" data-field="deliverySchedule" data-value="daily">
                        📅 <strong>Ежедневно</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('deliverySchedule', '2-3times', this)" data-field="deliverySchedule" data-value="2-3times">
                        📅 <strong>2-3 раза в неделю</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('deliverySchedule', 'weekly', this)" data-field="deliverySchedule" data-value="weekly">
                        📅 <strong>1 раз в неделю</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('deliverySchedule', 'ondemand', this)" data-field="deliverySchedule" data-value="ondemand">
                        📞 <strong>По мере необходимости</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('deliverySchedule', 'self', this)" data-field="deliverySchedule" data-value="self">
                        🚗 <strong>Закупаем сами</strong>
                    </button>
                </div>
                
                <h3>7.3 Приемка товара</h3>
                <p style="margin-bottom: 15px;">Кто принимает товар от поставщиков:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('goodsAcceptance', 'responsible', this)" data-field="goodsAcceptance" data-value="responsible">
                        👤 <strong>Назначенный ответственный</strong><br>
                        <small>повар, администратор</small>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('goodsAcceptance', 'anyone', this)" data-field="goodsAcceptance" data-value="anyone">
                        👥 <strong>Любой свободный сотрудник</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('goodsAcceptance', 'manager', this)" data-field="goodsAcceptance" data-value="manager">
                        👨‍💼 <strong>Руководитель лично</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('goodsAcceptance', 'rotation', this)" data-field="goodsAcceptance" data-value="rotation">
                        🔄 <strong>По очереди разные сотрудники</strong>
                    </button>
                </div>
                
                <h3>7.4 Документооборот</h3>
                <p style="margin-bottom: 15px;">Как ведется учет поступающих продуктов (можно выбрать несколько):</p>
                
                <div class="grid-3">
                    <button class="btn btn-secondary" onclick="toggleOption('documentation', 'journal', this)" data-field="documentation" data-value="journal" data-multiple="true">
                        📋 <strong>Ведем журнал приемки</strong><br>
                        <small>с проверкой документов</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('documentation', 'expiry', this)" data-field="documentation" data-value="expiry" data-multiple="true">
                        📅 <strong>Проверяем только сроки годности</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('documentation', 'minimal', this)" data-field="documentation" data-value="minimal" data-multiple="true" style="border-color: #ef4444;">
                        ❌ <strong>Принимаем без особых проверок</strong>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('documentation', 'accounting', this)" data-field="documentation" data-value="accounting" data-multiple="true">
                        💻 <strong>Фиксируем только в учетной программе</strong><br>
                        <small>(1С и т.д.)</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('documentation', 'mercury', this)" data-field="documentation" data-value="mercury" data-multiple="true">
                        🐄 <strong>Используем систему "Меркурий"</strong><br>
                        <small>для ветеринарных документов</small>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleOption('documentation', 'honestSign', this)" data-field="documentation" data-value="honestSign" data-multiple="true">
                        🏷️ <strong>Используем "Честный знак"</strong><br>
                        <small>для маркированных товаров</small>
                    </button>
                </div>
            `;
        }

        function generateStep8Content() {
            return `
                <h3>8.1 Структура персонала</h3>
                <p style="margin-bottom: 15px;">Ключевые позиции на кухне:</p>
                
                <div class="grid-3">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="chef" onchange="handleStaffChange(this)">
                        <span>👨‍🍳 Шеф-повар</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="production-manager" onchange="handleStaffChange(this)">
                        <span>📋 Заведующий производством</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="sous-chef" onchange="handleStaffChange(this)">
                        <span>👨‍🍳 Су-шеф</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="cooks" onchange="handleStaffChange(this)">
                        <span>👥 Повара</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="kitchen-workers" onchange="handleStaffChange(this)">
                        <span>🔧 Кухонные рабочие/помощники</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="waiters" onchange="handleStaffChange(this)">
                        <span>👥 Официанты</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="dishwashers" onchange="handleStaffChange(this)">
                        <span>🍽️ Посудомойщики</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="checkbox" name="staffStructure" value="storekeeper" onchange="handleStaffChange(this)">
                        <span>📦 Кладовщик</span>
                    </label>
                </div>
                
                <h3>8.2 Медицинские книжки</h3>
                <p style="margin-bottom: 15px;">Состояние медкнижек у персонала:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('medicalBooks', 'all-current', this)" data-field="medicalBooks" data-value="all-current">
                        ✅ У всех есть актуальные медкнижки
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('medicalBooks', 'in-progress', this)" data-field="medicalBooks" data-value="in-progress">
                        🔄 В процессе оформления у части персонала
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('medicalBooks', 'not-all', this)" data-field="medicalBooks" data-value="not-all" style="border-color: #ef4444;">
                        ❌ Не все оформили
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('medicalBooks', 'not-tracking', this)" data-field="medicalBooks" data-value="not-tracking" style="border-color: #ef4444;">
                        ❓ Не отслеживаем состояние медкнижек
                    </button>
                </div>
                
                <h3>8.3 Обучение персонала</h3>
                <p style="margin-bottom: 15px;">Проводится ли обучение по пищевой безопасности:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('staffTraining', 'regular', this)" data-field="staffTraining" data-value="regular">
                        ✅ Регулярные инструктажи с записью в журнал
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('staffTraining', 'onetime', this)" data-field="staffTraining" data-value="onetime">
                        📝 Разовое обучение при приеме на работу
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('staffTraining', 'informal', this)" data-field="staffTraining" data-value="informal">
                        🗣️ Неформальное обучение в процессе работы
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('staffTraining', 'none', this)" data-field="staffTraining" data-value="none" style="border-color: #ef4444;">
                        ❌ Не проводим специального обучения
                    </button>
                </div>
                
                <h3>8.4 Текучесть кадров</h3>
                <p style="margin-bottom: 15px;">Как часто меняется персонал:</p>
                
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="selectOption('staffTurnover', 'stable', this)" data-field="staffTurnover" data-value="stable">
                        ✅ Стабильный коллектив (увольнения редко)
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('staffTurnover', 'moderate', this)" data-field="staffTurnover" data-value="moderate">
                        🔄 Умеренная текучесть (1-2 человека в полгода)
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('staffTurnover', 'high', this)" data-field="staffTurnover" data-value="high">
                        ⚠️ Высокая текучесть (часто берем новых людей)
                    </button>
                    <button class="btn btn-secondary" onclick="selectOption('staffTurnover', 'constant', this)" data-field="staffTurnover" data-value="constant">
                        🔍 Постоянно ищем сотрудников
                    </button>
                </div>
            `;
        }

        // Обработчик для персонала
        function handleStaffChange(checkbox) {
            const fieldName = checkbox.name;
            const value = checkbox.value;
            
            if (!formData[fieldName]) formData[fieldName] = [];
            
            if (checkbox.checked) {
                if (!formData[fieldName].includes(value)) {
                    formData[fieldName].push(value);
                }
                checkbox.parentElement.style.borderColor = '#667eea';
                checkbox.parentElement.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
            } else {
                formData[fieldName] = formData[fieldName].filter(item => item !== value);
                checkbox.parentElement.style.borderColor = '#ddd';
                checkbox.parentElement.style.backgroundColor = 'transparent';
            }
            
            console.log('Персонал:', fieldName, '=', formData[fieldName]);
            autoSaveFormData();
        }
        // Обновление интерфейса
        function updateStepIndicator() {
            for (let i = 1; i <= 8; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                if (!stepEl) continue;
                
                stepEl.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === currentStep) {
                    stepEl.classList.add('active');
                }
            }
        }

        function updateProgressBar() {
            const progress = (currentStep / 8) * 100;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
        }

        function updateStepHeader() {
            const stepConfig = STEPS_CONFIG[currentStep - 1];
            const titleEl = document.getElementById('stepTitle');
            const subtitleEl = document.getElementById('stepSubtitle');
            
            if (titleEl) titleEl.textContent = stepConfig.title;
            if (subtitleEl) subtitleEl.textContent = stepConfig.subtitle;
        }

        function updateNavigationButtons() {
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (backBtn) {
                backBtn.style.display = currentStep === 1 ? 'none' : 'block';
            }
            
            if (nextBtn) {
                nextBtn.textContent = currentStep === 8 ? '🎯 Создать документы ХАССП' : 'Далее →';
            }
        }

        // Вспомогательные функции
        function toggleSameAddress() {
            const checkbox = document.getElementById('sameAddress');
            const actualAddressInput = document.getElementById('actualAddress');
            const legalAddressInput = document.getElementById('legalAddress');
            
            if (checkbox && checkbox.checked && legalAddressInput) {
                if (actualAddressInput) {
                    actualAddressInput.value = legalAddressInput.value;
                    actualAddressInput.disabled = true;
                    formData.actualAddress = legalAddressInput.value;
                }
            } else if (actualAddressInput) {
                actualAddressInput.disabled = false;
            }
            autoSaveFormData();
        }

        // Генерация документов
        function generateDocuments() {
            console.log('Генерируем документы с данными:', formData);
            
            document.getElementById('form').classList.add('hidden');
            document.getElementById('generating').classList.remove('hidden');

            const statuses = [
                'Валидация данных (30 сек)...',
                'AI-анализ заведения (1 мин)...',
                'Определение критических контрольных точек...',
                'Генерация плана ХАССП...',
                'Создание журналов контроля...',
                'Формирование инструкций персонала...',
                'Подготовка программы обучения...',
                'Финальная проверка (30 сек)...'
            ];

            const details = [
                'Проверяем корректность введенных данных',
                'Анализируем специфику вашего заведения',
                'Выявляем риски для вашего типа производства',
                'Создаем персонализированный план ХАССП',
                'Генерируем журналы под ваше оборудование',
                'Адаптируем инструкции под вашу структуру',
                'Составляем программу обучения персонала',
                'Проверяем соответствие требованиям НД'
            ];

            let progress = 0;
            let statusIndex = 0;

            const interval = setInterval(() => {
                progress += 12.5;
                const progressBar = document.getElementById('genProgress');
                const statusEl = document.getElementById('genStatus');
                const detailsEl = document.getElementById('genDetails');
                
                if (progressBar) {
                    progressBar.style.width = Math.min(progress, 100) + '%';
                }
                
                if (statusIndex < statuses.length && statusEl) {
                    statusEl.textContent = statuses[statusIndex];
                }
                
                if (statusIndex < details.length && detailsEl) {
                    detailsEl.textContent = details[statusIndex];
                }
                
                statusIndex++;

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        showResult();
                    }, 1000);
                }
            }, 800);
        }

        function showResult() {
            document.getElementById('generating').classList.add('hidden');
            
            // Обновляем заголовок с названием заведения
            const businessName = formData.businessName || 'вашего заведения';
            const resultTitle = document.getElementById('resultBusinessName');
            if (resultTitle) {
                resultTitle.textContent = `Персонализированные документы для "${businessName}"`;
            }
            
            // Создаем превью результата на основе реальных данных
            generateResultPreview();
            
            document.getElementById('result').classList.remove('hidden');
        }

        function generateResultPreview() {
            const preview = document.getElementById('resultPreview');
            if (!preview) return;
            
            const businessName = formData.businessName || 'Ваше заведение';
            const businessType = getBusinessTypeText();
            const menuItems = getMenuCount();
            const riskPoints = getRiskPointsCount();
            const journalsCount = getJournalsCount();
            const instructionsCount = getInstructionsCount();
            const pagesCount = getTotalPagesCount();
            
            preview.innerHTML = `
                <h3>📋 Ваши персонализированные документы готовы!</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <strong>📄 План ХАССП</strong><br>
                        <small>${pagesCount} страниц для "${businessName}"</small>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <strong>📊 Журналы контроля</strong><br>
                        <small>${journalsCount} журналов под ваш тип производства</small>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <strong>👥 Инструкции персонала</strong><br>
                        <small>${instructionsCount} должностных инструкций</small>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <strong>🎯 Анализ рисков</strong><br>
                        <small>Выявлено ${riskPoints} критических точек</small>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <strong>📋 Процедуры ХАССП</strong><br>
                        <small>${menuItems} технологических процессов</small>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <strong>✅ Чек-лист проверки</strong><br>
                        <small>Готовность к проверке РПН</small>
                    </div>
                </div>
                <p style="opacity: 0.8;">Все документы адаптированы под специфику ${businessType}</p>
            `;
        }

        // Вспомогательные функции для генерации реалистичного превью
        function getBusinessTypeText() {
            const typeMap = {
                'restaurant': 'ресторана',
                'cafe': 'кафе', 
                'canteen': 'столовой',
                'coffeehouse': 'кофейни',
                'bar': 'бара',
                'fastfood': 'фастфуда',
                'delivery': 'службы доставки',
                'bakery': 'пекарни/кондитерской'
            };
            return typeMap[formData.businessType] || 'заведения общественного питания';
        }

        function getMenuCount() {
            const menuCategories = formData.menuCategories || [];
            let baseCount = 12;
            
            // Увеличиваем количество в зависимости от категорий меню
            baseCount += menuCategories.length * 2;
            
            // Корректировка по типу заведения
            if (formData.businessType === 'restaurant') baseCount += 8;
            if (formData.businessType === 'fastfood') baseCount -= 5;
            if (formData.productionType === 'full') baseCount += 6;
            
            return Math.max(8, baseCount);
        }

        function getRiskPointsCount() {
            let riskPoints = 8; // Базовое количество
            
            // Увеличиваем риски в зависимости от особенностей
            const cookingFeatures = formData.cookingFeatures || [];
            if (cookingFeatures.includes('rawEggs')) riskPoints += 3;
            if (cookingFeatures.includes('rawFish')) riskPoints += 4;
            if (cookingFeatures.includes('rareMeat')) riskPoints += 2;
            
            if (formData.productionType === 'full') riskPoints += 5;
            if (formData.businessType === 'restaurant') riskPoints += 3;
            if (formData.seatingCapacity === '200+') riskPoints += 2;
            
            // Специализация кухни
            const specializations = formData.cuisineSpecialization || [];
            if (specializations.includes('asian')) riskPoints += 2;
            if (specializations.includes('children')) riskPoints += 3;
            
            return Math.min(25, riskPoints); // Максимум 25 точек
        }

        function getJournalsCount() {
            let journalsCount = 6; // Базовые журналы
            
            // Добавляем журналы в зависимости от оборудования
            const heating = formData.heatingEquipment || [];
            const cooling = formData.coolingEquipment || [];
            
            if (heating.length > 0) journalsCount += 2;
            if (cooling.length > 0) journalsCount += 2;
            if (heating.includes('fryer')) journalsCount += 1;
            
            // Дополнительные услуги
            const services = formData.additionalServices || [];
            if (services.includes('ownDelivery')) journalsCount += 2;
            if (services.includes('alcohol')) journalsCount += 1;
            
            return journalsCount;
        }

        function getInstructionsCount() {
            let instructionsCount = 4; // Базовые инструкции
            
            // Добавляем инструкции в зависимости от персонала
            const staff = formData.staffStructure || [];
            instructionsCount += Math.min(staff.length, 8);
            
            // Дополнительные инструкции
            if (formData.businessType === 'restaurant') instructionsCount += 2;
            if (formData.seatingCapacity !== 'none') instructionsCount += 1;
            
            return instructionsCount;
        }

        function getTotalPagesCount() {
            let pages = 25; // Базовый план ХАССП
            
            // Увеличиваем в зависимости от сложности
            if (formData.productionType === 'full') pages += 8;
            if (formData.businessType === 'restaurant') pages += 5;
            
            const menuCategories = formData.menuCategories || [];
            pages += menuCategories.length;
            
            const riskPoints = getRiskPointsCount();
            pages += Math.floor(riskPoints / 2);
            
            return Math.min(45, pages); // Максимум 45 страниц
        }

        function purchase() {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('Пожалуйста, введите email');
                return;
            }
            
            // Проверка email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Пожалуйста, введите корректный email');
                return;
            }
            
            // Сохраняем email в данные
            formData.customerEmail = email;
            autoSaveFormData();
            
            // Демо-версия
            alert(`🎉 Демо версия!\n\nВ реальной версии здесь будет:\n✅ Переход к оплате через ЮKassa\n✅ Генерация PDF документов\n✅ Отправка на email: ${email}\n\n📊 Ваши данные:\n• Заведение: ${formData.businessName || 'Не указано'}\n• Тип: ${getBusinessTypeText()}\n• Документов: ${getTotalPagesCount()} страниц\n• Журналов: ${getJournalsCount()} шт.\n\nСпасибо за тестирование ХАССП Конструктора!`);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 ХАССП Конструктор загружен и готов к работе');
            
            // Проверяем есть ли сохраненные данные
            if (loadSavedData()) {
                console.log('📁 Найдены сохраненные данные');
                
                // Показываем уведомление о восстановлении
                setTimeout(() => {
                    if (confirm('Найдены сохраненные данные предыдущего заполнения. Продолжить с того места, где остановились?')) {
                        startForm();
                        showStep(currentStep);
                    } else {
                        // Очищаем данные и начинаем заново
                        formData = {};
                        currentStep = 1;
                        localStorage.removeItem('haccpFormData');
                        localStorage.removeItem('haccpCurrentStep');
                    }
                }, 1000);
            }
            
            // Автоформатирование полей при вводе
            document.addEventListener('input', function(e) {
                if (e.target.id === 'inn') {
                    // Форматирование ИНН (только цифры)
                    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 12);
                }
                
                if (e.target.id === 'phone') {
                    // Форматирование телефона
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        if (value.length <= 11) {
                            value = value.replace(/^(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})$/, '+7 ($2) $3-$4-$5');
                            if (value.indexOf('+7 (') !== 0 && value.length > 1) {
                                value = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7, 9) + '-' + value.substring(9, 11);
                            }
                        }
                    }
                    e.target.value = value;
                }
            });
            
            // Обработка истории браузера
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.step) {
                    showStep(event.state.step);
                }
            });
            
            console.log('✅ Инициализация завершена успешно');
        });

        // Глобальные функции для доступа из HTML
        window.startForm = startForm;
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.selectOption = selectOption;
        window.toggleOption = toggleOption;
        window.toggleSameAddress = toggleSameAddress;
        window.handleEquipmentChange = handleEquipmentChange;
        window.handleStaffChange = handleStaffChange;
        window.generateDocuments = generateDocuments;
        window.purchase = purchase;
    </script>
</body>
</html>
